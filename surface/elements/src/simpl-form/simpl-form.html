<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<polymer-element name="xaction-button" extends="paper-button" attributes="xaction xid" noscript>
	<template>
		<style>
			:host /deep/ .button-content {
				padding-left: 5px;
				padding-right: 5px;
				padding-top: 12px;
				padding-bottom: 12px;
			}

		</style>
		<shadow></shadow>
	</template>
</polymer-element>

<polymer-element name="simpl-header" noscript>
	<template>
		<style>
			:host {
				font-size: 1.3em;
				padding: 16px 24px;
			}

		</style>
		<content></content>
	</template>
</polymer-element>

<polymer-element name="simpl-header2" noscript>
	<template>
		<style>
			:host {
				font-size: 0.75em;
				padding: 1.1em 24px;
			}

		</style>
		<content></content>
	</template>
</polymer-element>



<polymer-element name="simpl-group" vertical flex layout noscript>
	<template>
		<style>
			:host {
				margin-bottom: 40px;
				border: 1px solid #E0E0E0;
				border-radius: 4px;
				padding: 7px;
				background: white !important;
			}

		</style>
		<content></content>
	</template>
</polymer-element>

<polymer-element name="simpl-row" horizontal layout center wrap novanish noscript>
	<template>
		<style>
			html /deep/ [novanish] {
				min-height: 8px;
			}
			html /deep/ simpl-row {
				padding: 0 0px;
			}
			html /deep/ simpl-row >:not(:last-child) {
				margin-right: 0px;
			}

		</style>
		<content></content>
	</template>
</polymer-element>

<polymer-element name="simpl-baseform" attributes="actionCallback mode" vertical layout>
	<template>
		<link rel="stylesheet" type="text/css" href="grids.css">
		<link rel="stylesheet" type="text/css" href="grids-responsive.css">
		<style>
			:host {
				display: block;
				padding: 2px;
			}
			paper-tab.core-selected {
				border-radius: 6px;
			}
			paper-tab {} .tabcontainer {
				width: 100%;
			}
			fieldset#formdiv {
				border-radius: 6px;
				border: 0px solid beige;
			}
			input-field,
			dropdown-field {
				margin: 5px;
			}
			core-label {
				margin-bottom: 10px;
			}
			html-echo {
				color: red;
				margin: 15px;
			}
			xaction-button {
				margin-top: 20px;
			}
			xaction-button[xaction=execute] {
				color: #4285f4;
			}
			paper-item {
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
				font-size: 12px;
			}
			:host /deep/ paper-input-decorator[focused] /deep/ .floated-label .label-text {
				color: #000 !important;
			}
			:host /deep/ .focused-underline {
				background-color: #000;
			}
			paper-tab {
				//box-shadow: 0px 3px 2px rgba(0, 0, 0, 0.2);
			}
			paper-tabs.transparent-teal {
				background-color: transparent;
				color: #000;
				//box-shadow: 0px 3px 2px rgba(0, 0, 0, 0.2);
			}
			paper-tabs.transparent-teal::shadow #selectionBar {
				background-color: black;
			}
			paper-tabs.transparent-teal paper-tab::shadow #ink {
				color: beige;
			}
			[invisible] {
				visibility: hidden;
			}
			[exclude] {
				display: none !important;
			}

		</style>

		<paper-shadow z=1>

			<fieldset id="formdiv" verticax xayout>
				<template repeat="{{shapes}}" id="root">

					<template if="{{id=='Input' || id=='ActionButton' || id=='Enumselect' || id=='Textarea' || id=='Alert' || id=='break'}}" ref="element" bind></template>

					<template if="{{ id=='Tabview' }}" ref="tabs" bind></template>

					<template if="{{ id=='Group' }}" ref="group" bind></template>

					<template if="{{ id=='Row' }}" ref="row" bind></template>

					<template if="{{ id=='Form' }}" ref="form" bind></template>

				</template>

			</fieldset>
			</paper-shapes>

			<template id="form">
				<template ref="root" repeat="{{childShapes}}"></template>
			</template>

			<template id="group">
				<simpl-group class="group">
					<core-label for=".group">{{label}}</core-label>
					<template ref="root" repeat="{{childShapes}}"></template>
				</simpl-group>
			</template>

			<template id="row">
				<simpl-row>
					<template ref="root" repeat="{{childShapes}}"></template>
				</simpl-row>
			</template>

			<template id="tabs">
				<div class="tabcontainer" layout vertical felx>
					<paper-tabs class="transparent-teal" selected="{{selected}}">
						<template repeat="{{childShapes}}">
							<template if="{{ id=='Page' }}">
								<paper-tab id="{{xf_id}}">{{title||xf_id}}</paper-tab>
							</template>
						</template>
					</paper-tabs>

					<core-animated-pages selected="{{selected}}" vertical layout>
						<template repeat="{{childShapes}}">
							<template if="{{ id=='Page' }}">
								<section style="margin-top:20px;position:relative;padding:0px;">
									<template ref="element" repeat="{{childShapes}}"></template>
								</section>
							</template>
						</template>
					</core-animated-pages>
				</div>
			</template>

			<template id="element">
				<template if="{{ id=='Input' && xf_type == 'boolean' }}">
					<checkbox-field flex type={{xf_type}} enabled-expr="{{xf_enabled}}" readonly-expr="{{xf_readonly}}" invisible-expr="{{xf_invisible}}" exclude-expr="{{xf_exclude}}" data-constraints="{{regulaConstraints}}" name="{{xf_id}}" label="{{label}}" defaultValue="{{defaultValue}}"></checkbox-field>
				</template>
				<template if="{{ id=='Input' && xf_type != 'boolean' }}">
					<input-field flex type={{xf_type}} enabled-expr="{{xf_enabled}}" readonly-expr="{{xf_readonly}}"  invisible-expr="{{xf_invisible}}" exclude-expr="{{xf_exclude}}" data-constraints="{{regulaConstraints}}" name="{{xf_id}}" label="{{label}}" defaultValue="{{defaultValue}}"></input-field>
				</template>
				<template if="{{ id=='ActionButton' }}">
					<xaction-button on-tap="{{actionCallback}}" class="button" xid="{{xf_id}}" style="color:{{xf_action=='execute' ? '#4285f4' : 'black'}};" xaction="{{xf_action}}" raised>
						<core-icon icon="{{xf_iconname}}"></core-icon>{{xf_label}}
					</xaction-button>
				</template>
				<template if="{{ id=='Enumselect' }}">
					<dropdown-field flex name="{{xf_id}}" enabled-expr="{{xf_enabled}}" readonly-expr="{{xf_readonly}}"  invisible-expr="{{xf_invisible}}" exclude-expr="{{xf_exclude}}" defaultValue="{{defaultValue}}" label="{{label}}" raised>
						<template repeat="{{items}}">
							<paper-item name="{{value}}">{{label}}</paper-item>
						</template>
					</dropdown-field>
				</template>
				<template if="{{ id=='Textarea' }}">
					<multiline-field flex name="{{xf_id}}" enabled-expr="{{xf_enabled}}" readonly-expr="{{xf_readonly}}"  invisible-expr="{{xf_invisible}}" exclude-expr="{{xf_exclude}}" label="{{label}}" defaultValue="{{defaultValue}}"></multiline-field>
				</template>
				<template if="{{ id=='Alert' }}">
					<html-echo name="{{xf_id}}" html="{{xf_message}}"  invisible-expr="{{xf_invisible}}" exclude-expr="{{xf_exclude}}"></html-echo>
				</template>
				<template if="{{ id=='Group' }}" ref="group" bind></template>
				<template if="{{ id=='Row' }}" ref="row" bind></template>
			</template>
			<template if="{{ defaultButtons }}">
				<simpl-row>
					<xaction-button on-tap="{{actionCallback}}" class="button" xid="{{xf_id}}" xaction="execute" raised>
						<core-icon icon="check"></core-icon>{{'form.execute'|tr}}</xaction-button>
					<xaction-button on-tap="{{actionCallback}}" class="button" xid="{{xf_id}}" xaction="cancel" raised>
						<core-icon icon="clear"></core-icon>{{'tasks.form.cancel'|tr}}</xaction-button>
				</simpl-row>
			</template>

			<!--div>
			<button on-tap="{{submit}}">Submit</button>
		</div-->
	</template>
	<script>
		Polymer( 'simpl-baseform', {
			eventDelegates: {
				'value-changed': 'valueChanged',
				'add-form-field': 'addField',
				'remove-form-field': 'removeField'
			},
			valueChanged: function( e ) {
				console.debug( "valueChanged:", e );
				var map = {};
				for ( var i = 0, l = this.fields.length; i < l; i++ ) {
					var f = this.fields[ i ];
					map[ f.name ] = f.value;
				}
				map[ "isEdit" ] = this.mode == "edit";
				console.log( "Map:" + JSON.stringify( map, null, 2 ) );

				for ( var i = 0, l = this.fields.length; i < l; i++ ) {
					var f = this.fields[ i ];
					var enabledExpr = f.getAttribute( "enabled-expr" );
					var readonlyExpr = f.getAttribute( "readonly-expr" );
					console.log( "Name:" + f.name + "|enabled-expr:" + enabledExpr + "|readonlyExpr:" + readonlyExpr + "|" );
					if ( this.isNotEmpty( readonlyExpr ) ) {
						var e = this._maskedEval( readonlyExpr, map );
						if ( e ) {
							f.setAttribute( "disabled", "" );
						} else {
							f.removeAttribute( "disabled" );
						}
					} else if ( this.isNotEmpty( enabledExpr ) ) {
						var e = this._maskedEval( enabledExpr, map );
						if ( e ) {
							f.removeAttribute( "disabled" );
						} else {
							f.setAttribute( "disabled", "" );
						}
					}
					var excludeExpr = f.getAttribute( "exclude-expr" );
					console.log( "Name:" + f.name + "|excludeExpr:" + excludeExpr + "|" );
					if ( this.isNotEmpty( excludeExpr ) ) {
						var e = this._maskedEval( excludeExpr, map );
						if ( e ) {
							f.setAttribute( "exclude", "" );
						} else {
							f.removeAttribute( "exclude" );
						}
						console.log("exclude:"+e);
					}
					var invisibleExpr = f.getAttribute( "invisible-expr" );
					console.log( "Name:" + f.name + "|invisibleExpr:" + invisibleExpr + "|" );
					if ( this.isNotEmpty( invisibleExpr ) ) {
						var e = this._maskedEval( invisibleExpr, map );
						if ( e ) {
							f.setAttribute( "invisible", "" );
						} else {
							f.removeAttribute( "invisible" );
						}
						console.log("invisible:"+e);
					}
				}
			},
			isNotEmpty: function( s ) {
				if ( s == null || s.length == 0 ) {
					return false;
				}
				return true;
			},
			submit: function( e ) {
				var data = {};
				this.fields.forEach( function( f ) {
					data[ f.name ] = f.value;
				}, this );
				var jsonData = JSON.stringify( data, null, 2 );
				console.log( "Values:" + jsonData );
			},
			created: function() {},
			ready: function() {},
			domReady: function() {},
			shapesChanged: function() {
				console.debug( "shapesChanged:", this.shapes );
				this.valueChanged();
			},
			validate: function( e ) {
				var elements = this.filterToArray( this.$.formdiv.querySelectorAll( "input-field,checkbox-field" ) );
				Array.prototype.forEach.call( elements, function( elem ) {
					elem.setInvalid( false );
				} );
				if ( elements.length == 0 ) {
					return true;
				}
				regula.bind( {
					elements: elements
				} );
				var errorList = regula.validate( {
					elements: elements
				} );
				errorList.forEach( function( err ) {
					err.failingElements.forEach( function( elem ) {
						elem.setInvalid( true );
						elem.setErrorMessage( err.message );
					} );
				} );
				return errorList.length == 0;
			},
			filterToArray: function( nodeList ) {
				var ret = [];
				for ( var i = 0; i < nodeList.length; i++ ) {
					var c = nodeList[ i ].getAttribute( "data-constraints" );
					if ( c != null && c.length > 0 ) {
						ret.push( nodeList[ i ] );
					}
				}
				return ret;
			},
			_maskedEval: function( scr, env, def ) {
				try {
					return ( new Function( "with(this) { return " + scr + "}" ) ).call( env );
				} catch ( e ) {
					console.log( "Form._maskedEval:" + scr );
					console.error( "error:" + e );
					console.error( e.stack );
				}
				return def;
			},
			addField: function( e ) {
				this.fields.push( e.detail );
				this.fieldsMap[ e.detail.name ] = e.detail;
			},
			removeField: function( e ) {
				var i = this.fields.indexOf( e.detail );
				if ( i >= 0 ) {
					this.fields.splice( i, 1 );
				}
			},
			getLabel: function( path ) {
				var f = this.fieldsMap[ path ];
				return f.label;
			},
			setData: function( data ) {
				this.fields.forEach( function( field ) {
					field.withoutCheck = true;
					if ( field.setInvalid ) field.setInvalid( false );
					field.editValue = data[ field.name ] || field.defaultValue || "";
				}, this );
			},
			getData: function() {
				var data = {};
				this.fields.forEach( function( field ) {
					data[ field.name ] = field.value;
				}, this );
				return data;
			}
		} );

	</script>
</polymer-element>


<polymer-element name="simpl-form" extends="simpl-baseform" attributes="namespace formName variables" constructor="SimplForm" vertical layout>
	<template>
		<shadow></shadow>
	</template>
	<script>
		Polymer( 'simpl-form', {
			data: null,
			namespace: null,
			formName: null,
			formNameChanged: function() {
				this.fields = [];
				this.fieldsMap = {};
				console.log( "formNameChanged:", this.formName + "/" + this.namespace );
				var form = simpl4FormManager.getForm( this.formName, this.namespace );
				this.defaultButtons = form.properties.xf_default_buttons;
				this.shapes = this.prepareShape( form ).childShapes;
			},
			/*----------------------------------*/
			prepareShape: function( shape ) {
				shape = this.cleanShape( shape );

				if ( shape.id == 'Input' ) {
					shape.regulaConstraints = this.constructRegulaConstraints( shape[ "xf_constraint_" + shape.xf_type ] );
				}

				shape.childShapes = _.sortBy( shape.childShapes, function( element ) {
					return element.bounds.upperLeft.y * 10000 + element.bounds.upperLeft.x;
				} );
				var childShapes = shape.childShapes;
				shape.childShapes = [];
				var row = null;
				for ( var i = 0; i < childShapes.length; i++ ) {
					if ( shape.id == 'Tabview' ) {
						shape.childShapes.push( this.prepareShape( childShapes[ i ] ) );
					} else {
						if ( i == 0 || ( i > 0 && this.isLineBreak( childShapes[ i - 1 ], childShapes[ i ] ) ) ) {
							row = {
								id: 'Row',
								childShapes: []
							};
							shape.childShapes.push( row );
						}
						row.childShapes.push( this.prepareShape( childShapes[ i ] ) );
					}
				}
				return shape;
			},
			cleanShape: function( shape ) {
				if ( shape.stencil.id.toLowerCase() == "input" ||
					shape.stencil.id.toLowerCase() == 'textarea' ||
					shape.stencil.id.toLowerCase() == 'enumselect' ||
					shape.stencil.id.toLowerCase() == 'group'
				) {
					var labelChild = this.getLabelShape( shape.childShapes );
					if ( labelChild != null ) {
						shape.properties.label = labelChild.properties.xf_text;
						if ( ( shape.properties.xf_id == null || shape.properties.xf_id == "" ) && shape.properties.label ) {
							shape.properties.xf_id = shape.properties.label.toLowerCase().replace( /\s/g, '' );
						}
						if ( shape.childShapes.length == 1 ) {
							shape.childShapes = [];
						}
					} else {
						shape.properties.label = "";
					}
					if ( shape.stencil.id.toLowerCase() == 'enumselect' ) {
						var props = shape.properties;
						var enumembed = props.xf_enumembed;
						var si;
						if ( enumembed && enumembed.totalCount > 0 ) {
							si = simpl4FormManager.createSelectableItems( null, this.formName, props.xf_id, enumembed );
						} else {
							si = simpl4FormManager.createSelectableItems( null, this.formName, props.xf_id, JSON.stringify( props.xf_enum ) );
						}
						props.items = si.getItems();
					}
				} else if ( shape.stencil.id.toLowerCase() == "actionbutton" ) {
					var icon = shape.properties.xf_iconname;
					var action = shape.properties.xf_action;
					if ( icon == null || icon == "" ) {
						shape.properties.xf_iconname = ( action == "execute" ) ? "check" : "clear";
					}

				} else if ( shape.stencil.id.toLowerCase() == "alert" ) {
					shape.properties.xf_message = this.expandString( shape.properties.xf_message, this.variables );
				} else {
					shape.properties.label = "";
				}
				return _.extend( shape.properties, shape.stencil, {
					childShapes: shape.childShapes
				} );
			},
			getLabelShape: function( childs ) {
				for ( var i = 0; i < childs.length; i++ ) {
					if ( childs[ i ].stencil.id.toLowerCase() == 'label' ) {
						return childs[ i ];
					}
				}
				return null;
			},
			isLineBreak: function( child, next ) {
				var UL = child.bounds.upperLeft;
				var lineBreak = false;
				var nextUL = next.bounds.upperLeft;
				if ( UL.y != nextUL.y ) {
					lineBreak = true;
				}
				return lineBreak;
			},
			constructRegulaConstraints: function( constraints ) {
				if ( constraints == null || constraints.length == 0 ) return "";
				constraints = JSON.parse( constraints );
				var ret = "";
				var b = "";
				var keys = Object.keys( constraints );
				var self = this;
				keys.forEach( function( key ) {
					var values = constraints[ key ];
					if ( values[ 0 ] === true ) {
						ret += b + '@' + self.mapKeys( key );
						var params = self.constraintParams[ key ];

						ret += '(message="' + tr( "validation." + self.mapKeys( key ) ) + '"';
						if ( params && params.length > 0 ) {
							var pkey = params[ 0 ];
							var val = pkey == 'format' ? '"YMD"' : values[ 1 ];
							ret += ',' + pkey + '=' + val;
							if ( params.length > 1 ) {
								var pkey = params[ 1 ];
								var val = values[ 2 ];
								ret += ',' + pkey + '=' + val;
							}
						}
						ret += ')';
						b = ' ';
					}
				}, this );
				return ret;
			},
			mapKeys: function( key ) {
				if ( key == "NotNull" ) return "NotEmpty";
				return key;
			},
			constraintParams: {
				Max: [ "value" ],
				Min: [ "value" ],
				Range: [ "min", "max" ],
				Pattern: [ "regex" ],
				Length: [ "min", "max" ],
				Digits: [ "integer", "fraction" ],
				Past: [ "format" ],
				Future: [ "format" ],
				Step: [ "min", "max", "value" ]
			},
			expandString: function( str, binding ) {
				if ( str == null || str.length == 0 ) return "";
				var countRepl = 0;
				var countPlainStr = 0;
				var replacement = null;
				var newString = "";
				var openBrackets = 0;
				var first = 0;
				for ( var i = 0; i < str.length; i++ ) {
					if ( i < str.length - 2 && str.substring( i, i + 2 ) == "${" ) {
						if ( openBrackets == 0 ) {
							first = i + 2;
						}
						openBrackets++;
					} else if ( str.charAt( i ) == '}' && openBrackets > 0 ) {
						openBrackets -= 1;
						if ( openBrackets == 0 ) {
							countRepl++;
							replacement = this._maskedEval( str.substring( first, i ), binding );
							newString += replacement;
						}
					} else if ( openBrackets == 0 ) {
						newString += str.charAt( i );
						countPlainStr++;
					}
				}
				if ( countRepl == 1 && countPlainStr == 0 ) {
					return replacement;
				} else {
					return newString;
				}
			}
		} );

	</script>
</polymer-element>
